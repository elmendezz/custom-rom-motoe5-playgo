name: Pettyl Device Tree Generator

on:
  workflow_dispatch:
    inputs:
      firmware_link:
        description: 'Pega aquí el link directo de GoFile (o cualquier link directo)'
        required: true
        default: ''

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Instalar Dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip p7zip-full android-sdk-libsparse-utils wget curl
          pip3 install aospdtgen

      - name: Descargar Firmware Stock
        run: |
          # Usamos el link que pegaste en el input
          # -L es para seguir redirecciones si GoFile las tiene
          wget -L -O stock.zip "${{ github.event.inputs.firmware_link }}"

      - name: Extraer Firmware
        run: |
          mkdir -p stock_raw
          # Intentamos con unzip, si falla probamos con 7z
          unzip stock.zip -d stock_raw/ || 7z x stock.zip -ostock_raw/

      - name: Unir Particiones Motorola (Sparsechunks)
        run: |
          mkdir -p dump
          # Unimos los pedazos. Motorola suele usar system.img.0, .1 o system.img_sparsechunk.0
          # simg2img reconstruye la imagen completa para que el generador pueda leer el build.prop
          if ls stock_raw/system.img* 1> /dev/null 2>&1; then
            simg2img stock_raw/system.img* dump/system.img || cp stock_raw/system.img dump/system.img
          fi
          
          if ls stock_raw/vendor.img* 1> /dev/null 2>&1; then
            simg2img stock_raw/vendor.img* dump/vendor.img || cp stock_raw/vendor.img dump/vendor.img
          fi
          
          # El boot.img es sagrado para sacar el kernel y el dtb
          cp stock_raw/boot.img dump/boot.img || echo "Boot.img no encontrado"

      - name: Crear Device Tree
        run: |
          # Creamos el directorio solicitado en el root
          mkdir -p DeviceTree
          # Ejecutamos el generador sobre las imágenes unidas
          aospdtgen dump/ -o DeviceTree/

      - name: Subir el Device Tree como Artefacto
        uses: actions/upload-artifact@v4
        with:
          name: Moto-E5-Play-Pettyl-Tree
          path: DeviceTree/
