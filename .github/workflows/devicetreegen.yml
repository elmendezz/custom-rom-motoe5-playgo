name: Pettyl Device Tree Generator

on:
  workflow_dispatch:
    inputs:
      firmware_link:
        description: 'Link directo de GoFile o similar'
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar Herramientas
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip p7zip-full android-sdk-libsparse-utils curl file
          pip3 install aospdtgen

      - name: Descargar y Extraer ZIP
        run: |
          curl -L -o stock.zip "${{ github.event.inputs.firmware_link }}"
          mkdir -p stock_raw
          7z x stock.zip -ostock_raw/

      - name: Reconstrucción Exacta de Imágenes
        run: |
          mkdir -p dump/system dump/vendor
          
          echo ">>> Uniendo SYSTEM..."
          # Usamos mapfile para leer los archivos ordenados correctamente y evitar problemas de espacios
          mapfile -t SYS_CHUNKS < <(find stock_raw -type f -iname "*system*sparsechunk*" | sort -V)
          if [ ${#SYS_CHUNKS[@]} -gt 0 ]; then
            echo "Encontrados ${#SYS_CHUNKS[@]} fragmentos de System. Uniendo..."
            simg2img "${SYS_CHUNKS[@]}" dump/system.img
          else
            SYS_IMG=$(find stock_raw -type f -name "system.img" | head -n 1)
            [ -n "$SYS_IMG" ] && cp "$SYS_IMG" dump/system.img
          fi

          echo ">>> Uniendo VENDOR..."
          mapfile -t VEN_CHUNKS < <(find stock_raw -type f -iname "*vendor*sparsechunk*" | sort -V)
          if [ ${#VEN_CHUNKS[@]} -gt 0 ]; then
            echo "Encontrados ${#VEN_CHUNKS[@]} fragmentos de Vendor. Uniendo..."
            simg2img "${VEN_CHUNKS[@]}" dump/vendor.img
          else
            VEN_IMG=$(find stock_raw -type f -name "vendor.img" | head -n 1)
            [ -n "$VEN_IMG" ] && cp "$VEN_IMG" dump/vendor.img
          fi

          echo ">>> Copiando BOOT..."
          BOOT_IMG=$(find stock_raw -type f -name "boot.img" | head -n 1)
          [ -n "$BOOT_IMG" ] && cp "$BOOT_IMG" dump/boot.img

      - name: Extracción con 7-Zip (Bypass de Mount)
        run: |
          # Inspeccionamos qué tipo de imagen resultó (solo para debug en los logs)
          echo "Analizando system.img..."
          file dump/system.img || true
          
          if [ -f dump/system.img ]; then
            echo "Extrayendo System con 7z a la fuerza..."
            # 7z abre el .img y extrae todo a la carpeta dump/system/
            7z x dump/system.img -y -odump/system/ > /dev/null
            
            # Borramos la imagen original para que el generador solo vea la carpeta
            rm dump/system.img
          else
            echo "ERROR: dump/system.img no existe."
            exit 1
          fi

          if [ -f dump/vendor.img ]; then
            echo "Extrayendo Vendor con 7z a la fuerza..."
            7z x dump/vendor.img -y -odump/vendor/ > /dev/null
            rm dump/vendor.img
          fi

      - name: Crear Device Tree
        run: |
          mkdir -p DeviceTree
          # Ejecutamos el generador. Ahora leerá los archivos extraídos sin chistar.
          aospdtgen dump/ -o DeviceTree/

      - name: Subir el Device Tree
        uses: actions/upload-artifact@v4
        with:
          name: Moto-E5-Play-Pettyl-Tree
          path: DeviceTree/
