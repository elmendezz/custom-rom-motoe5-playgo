name: Pettyl Device Tree Generator

on:
  workflow_dispatch:
    inputs:
      firmware_link:
        description: 'Link directo de GoFile o similar'
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar Herramientas
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip p7zip-full android-sdk-libsparse-utils curl file
          pip3 install aospdtgen

      - name: Descargar y Extraer ZIP
        run: |
          curl -L -o stock.zip "${{ github.event.inputs.firmware_link }}"
          mkdir -p stock_raw
          7z x stock.zip -ostock_raw/

      - name: Fusión Física de Motorola (El Truco Definitivo)
        run: |
          mkdir -p dump temp_mount
          
          echo ">>> Uniendo SYSTEM..."
          # 1. Encontramos los fragmentos y los ordenamos numéricamente
          SYS_CHUNKS=$(find stock_raw -type f -iname "*system.img_sparsechunk*" | sort -V)
          if [ -n "$SYS_CHUNKS" ]; then
            echo "Fusionando fragmentos en un solo archivo sparse..."
            # 2. Los unimos a la fuerza en un solo archivo temporal
            cat $SYS_CHUNKS > sys_temp.img
            # 3. Ahora sí, simg2img lo convierte perfectamente
            simg2img sys_temp.img dump/system.img || mv sys_temp.img dump/system.img
          else
            SYS_IMG=$(find stock_raw -type f -iname "system.img" | head -n 1)
            [ -n "$SYS_IMG" ] && cp "$SYS_IMG" dump/system.img
          fi

          echo ">>> Uniendo VENDOR..."
          VEN_CHUNKS=$(find stock_raw -type f -iname "*vendor.img_sparsechunk*" | sort -V)
          if [ -n "$VEN_CHUNKS" ]; then
            cat $VEN_CHUNKS > ven_temp.img
            simg2img ven_temp.img dump/vendor.img || mv ven_temp.img dump/vendor.img
          else
            VEN_IMG=$(find stock_raw -type f -iname "vendor.img" | head -n 1)
            [ -n "$VEN_IMG" ] && cp "$VEN_IMG" dump/vendor.img
          fi

          echo ">>> Copiando BOOT..."
          BOOT_IMG=$(find stock_raw -type f -name "boot.img" | head -n 1)
          [ -n "$BOOT_IMG" ] && cp "$BOOT_IMG" dump/boot.img

      - name: Verificar y Extraer (Mount)
        run: |
          # Esto nos dirá en el log si la imagen es válida (debe decir "ext4 filesystem")
          echo "Analizando tipo de archivo..."
          file dump/system.img
          
          if [ -f dump/system.img ]; then
            echo "Montando y extrayendo System (Ahora sí funcionará)..."
            mkdir -p dump/system
            sudo mount -o ro,loop dump/system.img temp_mount
            sudo cp -a temp_mount/* dump/system/
            sudo umount temp_mount
            rm dump/system.img # Borramos para ahorrar espacio
          fi

          if [ -f dump/vendor.img ]; then
            echo "Montando y extrayendo Vendor..."
            mkdir -p dump/vendor
            sudo mount -o ro,loop dump/vendor.img temp_mount
            sudo cp -a temp_mount/* dump/vendor/
            sudo umount temp_mount
            rm dump/vendor.img
          fi
          
          # Restauramos los permisos para que el generador pueda leer la carpeta
          sudo chown -R $USER:$USER dump/

      - name: Crear Device Tree
        run: |
          mkdir -p DeviceTree
          aospdtgen dump/ -o DeviceTree/

      - name: Subir el Device Tree
        uses: actions/upload-artifact@v4
        with:
          name: Moto-E5-Play-Pettyl-Tree
          path: DeviceTree/
