name: Pettyl Device Tree Generator

on:
  workflow_dispatch:
    inputs:
      firmware_link:
        description: 'Link directo de GoFile o similar'
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar Herramientas
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip p7zip-full android-sdk-libsparse-utils wget curl
          pip3 install aospdtgen

      - name: Descargar y Extraer
        run: |
          wget -L -O stock.zip "${{ github.event.inputs.firmware_link }}"
          mkdir -p stock_raw
          7z x stock.zip -ostock_raw/

      - name: Unir Particiones (Fix Motorola Sparsechunks)
        run: |
          mkdir -p dump
          
          # Funci칩n para unir pedazos de Motorola
          # Buscamos archivos tipo system.img_sparsechunk.0, system.img.0, etc.
          echo "Procesando SYSTEM..."
          SYSTEM_FILES=$(ls stock_raw/system*img* | sort -V)
          if [ -n "$SYSTEM_FILES" ]; then
            simg2img $SYSTEM_FILES dump/system.img || cp stock_raw/system.img dump/system.img || echo "No se pudo procesar system"
          fi

          echo "Procesando VENDOR..."
          VENDOR_FILES=$(ls stock_raw/vendor*img* | sort -V)
          if [ -n "$VENDOR_FILES" ]; then
            simg2img $VENDOR_FILES dump/vendor.img || cp stock_raw/vendor.img dump/vendor.img || echo "No se pudo procesar vendor"
          fi

          # Copiamos el boot.img (indispensable)
          cp stock_raw/boot.img dump/boot.img || echo "Boot.img no encontrado"
          
          # Listamos lo que qued칩 para debuggear si falla
          ls -lh dump/

      - name: Crear Device Tree
        run: |
          # Si el dump no tiene system.img, el generador fallar치. 
          # Verificamos si existe antes de correrlo.
          if [ ! -f dump/system.img ]; then
            echo "ERROR: No se encontr칩 dump/system.img. Revisa los nombres de los archivos en el zip."
            exit 1
          fi
          
          mkdir -p DeviceTree
          aospdtgen dump/ -o DeviceTree/

      - name: Subir el Device Tree
        uses: actions/upload-artifact@v4
        with:
          name: Moto-E5-Play-Pettyl-Tree
          path: DeviceTree/
