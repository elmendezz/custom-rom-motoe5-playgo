name: Pettyl Device Tree Generator

on:
  workflow_dispatch:
    inputs:
      firmware_link:
        description: 'Link directo de GoFile o similar'
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar Herramientas
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip p7zip-full android-sdk-libsparse-utils curl
          pip3 install aospdtgen

      - name: Descargar y Extraer ZIP
        run: |
          curl -L -o stock.zip "${{ github.event.inputs.firmware_link }}"
          mkdir -p stock_raw
          7z x stock.zip -ostock_raw/

      - name: Búsqueda Profunda y Reconstrucción
        run: |
          mkdir -p dump/system dump/vendor temp_mount
          
          echo ">>> Buscando y uniendo SYSTEM..."
          # Buscamos en todas las subcarpetas y ordenamos por versión (-V)
          SYS_CHUNKS=$(find stock_raw -name "system.img_sparsechunk.*" | sort -V)
          SYS_IMG=$(find stock_raw -type f -name "system.img")
          
          if [ -n "$SYS_CHUNKS" ]; then
            simg2img $SYS_CHUNKS dump/system.img
          elif [ -n "$SYS_IMG" ]; then
            simg2img $SYS_IMG dump/system.img || cp $SYS_IMG dump/system.img
          fi

          echo ">>> Buscando y uniendo VENDOR..."
          VEN_CHUNKS=$(find stock_raw -name "vendor.img_sparsechunk.*" | sort -V)
          VEN_IMG=$(find stock_raw -type f -name "vendor.img")
          
          if [ -n "$VEN_CHUNKS" ]; then
            simg2img $VEN_CHUNKS dump/vendor.img
          elif [ -n "$VEN_IMG" ]; then
            simg2img $VEN_IMG dump/vendor.img || cp $VEN_IMG dump/vendor.img
          fi

          echo ">>> Buscando BOOT..."
          BOOT_IMG=$(find stock_raw -type f -name "boot.img" | head -n 1)
          if [ -n "$BOOT_IMG" ]; then
            cp "$BOOT_IMG" dump/boot.img
          fi

      - name: Extracción Nativa (Evita el AssertionError)
        run: |
          # Montamos las imágenes ext4 reales y copiamos los archivos
          # Esto le da a aospdtgen los archivos limpios (build.prop, etc)
          
          if [ -f dump/system.img ]; then
            echo "Extrayendo contenidos de System..."
            sudo mount -o ro,loop dump/system.img temp_mount
            sudo cp -a temp_mount/* dump/system/
            sudo umount temp_mount
            rm dump/system.img # Borramos la imagen para ahorrar espacio
          else
            echo "ERROR: System no se generó. Revisa tu archivo ZIP."
            exit 1
          fi

          if [ -f dump/vendor.img ]; then
            echo "Extrayendo contenidos de Vendor..."
            sudo mount -o ro,loop dump/vendor.img temp_mount
            sudo cp -a temp_mount/* dump/vendor/
            sudo umount temp_mount
            rm dump/vendor.img
          fi

          # Aseguramos que el generador tenga permisos de lectura
          sudo chown -R $USER:$USER dump/

      - name: Crear Device Tree
        run: |
          mkdir -p DeviceTree
          aospdtgen dump/ -o DeviceTree/

      - name: Subir el Device Tree
        uses: actions/upload-artifact@v4
        with:
          name: Moto-E5-Play-Pettyl-Tree
          path: DeviceTree/
